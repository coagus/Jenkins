def InputCSVPath

pipeline {
    agent any

    stages {
        stage('Cargar CSV') {
            steps {
                script {
					echo "*** SE PIDE EL CSV PARA CARGARLO ***"
                    InputCSVPath = input message:'Cargar', parameters:  [file(name:'archivo.csv', description:'Cargar CSV')]
                }                
            }
        }
		
		stage('Validar y Publicar') {
			steps {
				script {
					echo "*** LEEMOS ARCHIVO CSV ***"
					readFile("${InputCSVPath}").split('\n').each { 
							line, count -> def fields = line.split(',')

                            if (fields[1].trim() == '1') {
                                echo ">>> VALIDANDO EL PROYECTO ${fields[0].trim()}"
                                def response = httpRequest url:"http://{{url}}/ecm/ecm/CatalogManagement/v2/project/${fields[0].trim()}/validate", 
                                    httpMode: 'POST', customHeaders: [[name: 'OnBehalfOf', value: 'upadmin']]
                                println('Status: '+response.status)
                                println('Response: '+response.content)
                            }

                            //println(fields[0].trim() + "\t'" + fields[1].trim() + "'\t'" + fields[2].trim() + "'\t'" + fields[3].trim() + "'")
                            //println((fields[1].trim() == '1' ? 'Valida' : '') + (fields[2].trim() == '1' ? ', Publica BSCS' : '') + (fields[3].trim() == '1' ? ', Publica CS' : ''))
					}
                }
			}
		}
		/*
		stage('Validar') {
            steps {
                script {
                    def response = httpRequest url:"http://{{url}}/ecm/ecm/CatalogManagement/v2/project/AmxCoMovPreAddonsBund048_B27/validate", httpMode: 'POST', customHeaders: [[name: 'OnBehalfOf', value: 'upadmin']]
                    println('Status: '+response.status)
                    println('Response: '+response.content)
                }
            }		    
		}*/
    }
}
